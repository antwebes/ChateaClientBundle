{% extends "ChateaClientBundle::mainLayout.html.twig" %}

{% trans_default_domain 'UserRegistration' %}

{% block chatea_title %}{{ 'user.register_profile' | trans }}{% endblock %}
{% block chatea_meta_description %}{% endblock %}
{% block chatea_meta_keywords %}{% endblock %}

{% block chatea_body %}
    {% if problem is not null %}
        <div class="alert alert-warning" role="alert">{{ problem | trans }}</div>
    {% endif %}

    <h1>{{ 'user.register_profile' | trans }}</h1>
<div class="col-xs-12">
    <form id="profileForm" class="form-horizontal" action="{{ path('chatea_user_profile', {"userId": user.id } ) }}" {{ form_enctype(form) }} method="POST">
        {% if alerts is not null %}
            <div class="alert alert-warning">
                {{ alerts }}
            </div>
        {% endif %}
        {% if errors | length > 0 %}
            <div class="alert alert-danger">
                {{ form_errors(form) }}
            </div>
        {% endif %}

        <div class="form-group">
            <label class="col-lg-3 control-label" for="user_profile_gender">{{ "form.label.gender" | trans }}</label>
            <div class="col-lg-9">
                {{ form_errors(form.gender) }}
                {{ form_widget(form.gender, {'attr': {'class': 'form-control' }, 'translation_domain' : 'UserRegistration' }) }}
            </div>
        </div>
        <div class="form-group">
            <label class="col-lg-3 control-label" for="user_profile_seeking">{{ "form.label.seeking" | trans }}</label>
            <div class="col-lg-9">
                {{ form_errors(form.seeking) }}
                {{ form_widget(form.seeking, {'attr': {'class': 'form-control' }, 'translation_domain' : 'UserRegistration' }) }}
            </div>
        </div>
        <div class="form-group">
            <label class="col-lg-3 control-label" for="user_profile_youWant">{{ "form.label.youWant" | trans }}</label>
            <div class="col-lg-9">
                {{ form_errors(form.youWant) }}
                {{ form_widget(form.youWant, {'attr': {'class': 'form-control', 'placeholder': 'form.placeholder.youWant' }, 'translation_domain' : 'UserRegistration' }) }}
            </div>
        </div>
        <div class="form-group">
            <label class="col-lg-3 control-label" for="user_profile_about">{{ "form.label.about" | trans }}</label>
            <div class="col-lg-9">
                {{ form_errors(form.about) }}
                {{ form_widget(form.about, {'attr': {'class': 'form-control', 'placeholder': 'form.placeholder.about' }, 'translation_domain' : 'UserRegistration' }) }}
            </div>
        </div>
        <div class="form-group">
            <label class="col-lg-3 control-label">{{ form_label(form.image) }}</label>
            <div class="col-lg-9">
                {{ form_errors(form.image) }}
                {{ form_widget(form.image) }}
            </div>
        </div>
        {{ form_widget(form._token) }}
        {{ form_rest(form) }}
        <div class="form-group row">
            <div class="col-sm-1">
                <a id="skipBtn" class="btn btn-lg" role="button" href="{{ path('chatea_client_register_user_success',{'userId': user.id }) }}">
                    {{ 'user.register_profile.skip' | trans }}
                </a>
            </div>
            <div class="col-sm-offset-2 col-sm-10">
                <input name="register" type="submit" class="btn btn-lg pull-right btn-primary" value="{{ 'registration_profile.submit'|trans }}" />
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block chatea_js %}
    {{ parent() }}
    <script>
        $(function(){
            // we need this variable becaus if we choose a file we habe to send data via FormData.
            // If we use FormData without choosing a file, we send an empnty image and therfore produce an error on the server
            var sendFile = false;

            $('#profileForm input[type=file]').on('change', function(){ //we have choosen a file
                sendFile = true;
            });

            $('#profileForm')
                .submit( function( e ) {
                    if(sendFile){
                        var formData = new FormData( this );

                        $.ajax( {
                            url: '{{ api_endpoint }}/api/users/{{ user.id }}/profiles?access_token={{ access_token }}',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            crossDomain: true,
                            success: function(){
                                window.location.href = '{{ path('chatea_client_register_user_success',{'userId': user.id }) }}';
                            }
                        } );
                    }else{
                        //no file was choosen, we serialize the form in normal form
                        var formData = $('#profileForm').serialize();

                        $.ajax( {
                            url: '{{ api_endpoint }}/api/users/{{ user.id }}/profiles?access_token={{ access_token }}',
                            type: 'POST',
                            data: formData,
                            success: function(){
                                window.location.href = '{{ path('chatea_client_register_user_success',{'userId': user.id }) }}';
                            }
                        } );
                    }

                    e.preventDefault();
                });
        });
    </script>
{% endblock %}
